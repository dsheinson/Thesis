\chapter{Statistical analysis of fMRI data \label{ch:fmri}}

In this chapter, we use models and tools described in Chapters \ref{ch:models} and \ref{ch:meth} to analyze time series data collected from a functional magnetic resonance imaging (fMRI) experiment. We describe the most common method of statistical analysis used in the field, i.e. the correlation-based general linear model (GLM) approach \citep{friston:frith:JCBFM:1991,friston:holmes:hbm:1995}, and discuss challenges associated with analyzing fMRI data using this method. We mainly focus on the problem of how to deal with temporally autocorrelated data. Autocorrelated time series invalidate results obtained using the standard GLM, which assumes independence of the error terms in the model. We explore possible variations of the GLM to account for this autocorrelation and show via simulation the negative consequences of using the standard GLM to analyze autocorrelated data.

We then fit fMRI data collected from a word recognition experiment to the dynamic regression models described in Section \ref{sec:dlm:arwn} using maximum likelihood estimation, and we propose a model comparison strategy using PL. Using simulated data, we explore possible identifiability issues associated with these models and use PL to examine conditions under which the models can be distinguished from one another. Finally, we analyze real fMRI data using PL and discuss the appropriateness of the dynamic slope model for this data and as a tool for future fMRI studies.

In Section \ref{sec:fmri:intro}, we provide an overview of fMRI and describe the experimental data set. In Section \ref{sec:fmri:cor}, we compare different models with autocorrelated error structures and explore their impact on fitted model residuals as well as false positive rates of concluding significant brain activation. In Section \ref{sec:fmri:id}, we investigate identifiability issues associated with the dynamic regression models described in Section \ref{sec:dlm:arwn}, and we fit real and simulated fMRI data to these models using maximum likelihood estimation. Finally, in Section \ref{sec:fmri:pl}, we use simulated data to examine the possibility of comparing these dynamic regression models using PL, and we discuss results from applying PL to real fMRI data.

\section{Overview of fMRI \label{sec:fmri:intro}}

Functional MRI provides an indirect measure of neural activation in the brain in near real time. Most fMRI experiments measure the \emph{blood oxygen level-dependent (BOLD) signal}, or ratio of oxygenated to deoxygenated hemoglobin in the blood. Evidence suggests that a type of neural activity called the local field potential is closely related to the BOLD signal recorded in an fMRI experiment \citep{logo:bold:2003,logo:bold:2001}. By providing a noninvasive way to study functional changes in the brain over time, fMRI has allowed researchers to study topics that had previously seemed impossible to give a detailed scientific investigation, such as the nature of consciousness \citep{lloyd:conscious:2002}, meditation \citep{cahn:med:2006}, and moral judgement \citep{greene:moral:2001}.

The BOLD response to a neural impulse is characterized by an increase in the BOLD signal from a baseline level to its peak at around 6 seconds post-stimulus, followed by a gradual decay back to baseline over the next 20-25 seconds. This typical BOLD response to an impulse as a function of time is referred to as the \emph{haemodynamic response function (hrf)}, and knowledge about this function is crucial for effectively analyzing data from fMRI experiments. Although studies have shown that the hrf varies from person to person based on factors such as age \citep{rich:hrf:2003}, most analyses assume a known form of the hrf for all subjects. A commonly used hrf that is thought to represent an average BOLD response for a typical subject is defined by the SPM software package for analysis of fMRI data (http://www.fil.ion.ucl.ac.uk/spm/doc/). This hrf is known as the canonical hrf (see bottom panel of Figure \ref{fig:fmri:data}). Another commonly used hrf is the gamma function proposed by \citet{boyn:linear:1996}, given by
\begin{equation}
h(t) = \frac{(t/\tau)^{n-1}e^{-t/\tau}}{\tau(n-1)!}, \label{eqn:hrf}
\end{equation}
where $t$ is time in seconds and $\tau$ and $n$ are free parameters that determine the shape of the hrf.

An fMRI scanning session consists of one or more runs in which a human subject is presented with a simple task designed to stimulate the brain while scans are taken every few seconds. Runs can typically last anywhere between 10 and 30 minutes, and the \emph{repetition time (TR)}, or length between individual scans, can be anywhere between 1 and 3 seconds. Each scan involves taking cross-sectional slices across the whole brain. Although TRs less than one second are possible on some machines, increasing the TR often comes at the cost sacrificing spatial resolution of the images resulting from each scan.

Each image consists of a three-dimensional array of volumetric pixels, or \emph{voxels}, and each voxel contains a value of the BOLD response for a small area of the brain. Voxel size and TR are important choices that must be made prior to running an experiment based on desired spatial and temporal resolution of the data. An average experiment might involve three 10-minute scanning runs with a TR of 2 seconds, and an average scan might consist of 36 slices, where each slice consists of a 64 by 64 array of 3 $\mbox{mm}^2$ voxels. In this average scenario, each image would be made up of 147,456 voxels, and data from the entire scanning session would contain 132,710,400 BOLD values. Combining this with the fact that many studies involve multi-subject experiments, the sheer size of fMRI data sets impose significant challenges for data analysis.

In addition to choosing scanning parameters such as voxel size and TR, designing an fMRI experiment also involves deciding on how the experimental stimulus is presented to the subject in the scanner. Three experimental designs used in fMRI are block designs, slow event-related designs, and rapid event-related designs. Block designs divide functional runs into blocks of continuous activity and continuous rest, usually lasting anywhere from 30 seconds to a couple of minutes. During the activation blocks, subjects are instructed to perform the same task continuously over the entire block. In event-related designs, the pattern of the stimulus \emph{onsets}, or TRs at which an experimental stimulus is presented to the subject, is chosen randomly, with the time between onsets usually somewhere between 2 and 16 seconds. Slow event-related designs include rest periods that last around 30 seconds, while rapid event-related designs use shorter rest periods.

The long rest periods included in block and slow event-related designs are meant to allow the BOLD response to decay back to baseline before the next stimulus presentation. This helps increase the power of statistical tests designed to identify neural activation or distinguish between event types. However, these designs result in longer experiments which are more expensive and incur a greater risk of having the subject's mind wander during rest periods and generate non-task related BOLD signal. Rapid event-related designs have become more popular with the development of statistical methods such as the GLM approach that make analysis of data collected from experiments with rapid event-related designs possible.

This section is intended to provide a quick overview of fMRI for the purpose of giving context to the analyses discussed in the rest of this chapter. For more information on fMRI and designing fMRI experiments, we refer the reader to \citet{ashby:fmri:2011,pold:fmri:2011}.

\subsection{The correlation-based GLM approach \label{sec:fmri:glm}}

The standard correlation-based GLM analysis of fMRI data models the observed BOLD response in a single voxel of the brain as a linear function of the expected BOLD response from a voxel responding to the experimental stimulus, i.e.
\begin{equation}
y_t = \beta_0 + \beta_1\mbox{conv}_t + v_t, \label{eqn:fmri:glm}
\end{equation}
where $y_t$ is the observed BOLD response at TR $t$, $\mbox{conv}_t$ is the expected BOLD response at TR $t$ in an active voxel, $\beta = (\beta_0,\beta_1)'$ are unknown fixed regression coefficients, and $v_t \stackrel{iid}{\sim} \mbox{N}(0,\sigma^2_m)$ are independent measurement errors. The expected BOLD response, $\mbox{conv}_t$, is calculated by convolving the hrf with an ``on-off'' boxcar function that is equal to 1 at TRs when the experimental stimulus is on and 0 when it is off. Specifically,
\begin{equation}
\mbox{conv}_t = \int_0^t N(\omega)h(t-\omega)d\omega, \label{eqn:fmri:conv}
\end{equation}
where $N(\omega)$ represents the value of the neural activation boxcar at time $\omega$. Note that $N(t)$, $h(t)$, and hence $\mbox{conv}_t$ can be defined in continuous time. However, since we observe the BOLD response at discrete time points determined by the TR, we define the time index $t$ in units of TRs in a GLM analysis. Expected responses to different event types can be included in this model as additional covariates by convolving the hrf with the boxcar function associated with each event.

Under the model given in equation \eqref{eqn:fmri:glm}, the hypothesis test
\begin{equation}
H_0: \beta_1 = 0 \quad H_A: \beta_1 > 0 \label{eqn:fmri:hyp}
\end{equation}
is usually of interest, where rejection of $H_0$ in favor of $H_A$ is interpreted as evidence of neural activation in that particular voxel. To test this hypothesis, ordinary least squares estimates of the unknown fixed parameters $\beta$ and $\sigma^2_m$ are computed, i.e.
\begin{equation}
\hat{\beta}  = (\hat{\beta}_0,\hat{\beta}_1)' = (X'X)^{-1}X'y \qquad \hat{\sigma}^2_m = \frac{1}{T-2}\lVert y-X\hat{\beta} \rVert, \label{eqn:fmri:ols}
\end{equation}
where $T$ is the total number of TRs in the functional run, $X$ is the $T$ by $2$ design matrix with first column all 1's and second column equal to $\mbox{conv}_t$, $y = (y_1,\ldots,y_T)'$, and $\lVert\cdot\rVert$ is the Euclidean norm. The test statistic, $t^*$, and p-value, $p^*$, are then calculated by
\begin{equation}
t^* = \frac{\hat{\beta}_1}{\hat{\sigma}^2_m(X'X)_{(2,2)}^{-1}} \qquad p^* = \mbox{P}(t^* > 0|H_0), \label{eqn:fmri:ttest}
\end{equation}
where $(X'X)_{(2,2)}^{-1}$ is the element in the second row and second column of $(X'X)^{-1}$ and $P(A|H_0)$ is the probability of event $A$ assuming $H_0$ is true. Thus, $p^*$ is calculated under the assumption that $t^* \sim \mbox{T}(0,1,T-2)$ and $H_0$ is rejected if $p^*$ is less than some significance threshold $\alpha$.

The majority of fMRI studies perform this hypothesis test independently for every voxel, resulting in a statistical parametric map of brain activation. With this approach, an adjustment to the significance threshold $\alpha$ must be made to account for multiple hypothesis tests being performed simultaneously. For example, if a false positive rate of $\alpha = 0.05$ is desired, a corrected threshold $\alpha^*$ must be used for each independent test so that the probability of a false positive among all tests is 0.05. Because of the spatial relationship among voxels, these hypothesis tests are not actually independent of each other, and this complicates the problem of finding the necessary correction. Typically, an approach relying on the theory of Gaussian random fields is used \citep{wors:grf:1995,wors:mar:cerebral:1996,wors:evans:cerebral:1992,friston:frith:JCBFM:1991}.

The standard GLM approach to analyzing fMRI data, which models univariate time series separately for each voxel, is convenient because regression theory allows for simple forms of estimators and fast computation. However, aside from using a multiple comparisons correction, the spatial nature of fMRI data and the connection between voxel-wise time series is ignored using this approach. Hence, a second-stage connectivity analysis is required to gain any insight into neural networks. The development of multivariate methods that analyze activation and connectivity simultaneously has gained popularity over the last decade. These include independent components analysis \citep{beck:smith:ica:2004}, multi-voxel pattern recognition \citet{norman:mvpa:2006}, representation similarity analysis \citep{nili:rs:2014}, and Bayesian spatio-temporal modeling approaches such as those developed by \citet{wool:jenk:bayesSp:2004}, \citet{bowman:2008:SpMCMC}, \citet{quiros:diez:2010:BayesSpTemp}, and \citet{zhang:guin:2014:npBayesWave}, to name a few.

While the development of efficient numerical approximation algorithms have decreased the computational burden of analyzing fMRI data using Bayesian spatio-temporal models, they are still slower and more difficult to implement than the standard GLM approach. Thus, voxel-wise hypothesis tests are still the norm in fMRI data analysis, and we operate within the framework of the univariate GLM for the remainder of this chapter. For more information on fMRI and standard statistical techniques used in the field including the GLM, the multiple comparisons problem, and multivariate strategies, see \citet{ashby:fmri:2011, penny:spm:2011}.

\subsection{Word recognition task \label{sec:fmri:data}}

The data set that we analyze in Sections \ref{sec:fmri:dr} and \ref{sec:fmri:pl} come from an episodic word recognition experiment for one human subject. The task the subject worked on consisted of an encoding session that takes place outside of the scanner and a recognition session that takes place inside the scanner. During encoding, the subject was presented with a list of words presented one at a time and told to memorize the words so that if they saw the word again, they would recognize it. During the recognition session, the subject was presented with a another list of words, some of which they saw during encoding and some of which were new. The subject was asked to respond as to whether they thought each word was old or new based on their memory.

While in the scanner, the words were presented according to a rapid-event related design with a random delay between 2 and 10 seconds. The expected BOLD response ($\mbox{conv}_t$) is then constructed by convolving the canonical hrf with a boxcar function that is equal to 1 during TRs when a word is presented to the subject and 0 otherwise. The middle panel of Figure \ref{fig:fmri:data} shows $\mbox{cont}_t$ for this experiment. Scans were taken with a TR of 1.5 seconds and voxel size of 3 $\mbox{mm}^3$. Although the data was recorded for the entire brain, we look specifically at time series from 5 by 5 by 5 voxel cubes (125 voxels per cube) extracted from six different brain regions, namely the left frontal pole (FP), left intraparietal sulcus (IPS-left), right intraparietal sulcus (IPS-right), primary visual cortex (PV), left secondary visual cortex (SV-left), and right secondary visual cortex (SV-right).

An important step that is performed prior to analyzing fMRI data is preprocessing of the raw data that comes directly out of the scanner. For example, images need to be spatially realigned to reduce the effect of the subject's head movements while in the scanner. In addition, a high-resolution structural image taken prior to the functional run can be used to discern the exact location of voxels that are difficult to locate in the functional images due to the lower resolution. This process is called \emph{coregistration} of the functional and structural data. The coregistered data then needs to be normalized to a standard brain atlas so that active voxels can be assigned to a neuroanatomic brain structure. For this data set, the functional time series were spatially realigned to the first image using a least squares approach with a 6-parameter rigid body affine transformation \citep{friston:ash:spreg:1995}. Realigned images were then ``unwarped'' to reduce the influence of residual movement-related variance on BOLD signal intensity \citep{andersson:deform:2001}. The functional data were then coregistered to a high-resolution T1 anatomical image using mutual information maximization with a 6-parameter rigid body affine transform \citep{ashburner:neelin:reg:1997}. The images were normalized to standard 3D brain atlas defined by the International Consortium for Brain Mapping using a combination of a 12-parameter linear affine transformation and 3 by 2 by 3 nonlinear three-dimensional discrete cosine transform, and a 7th degree B-spline was used as the interpolation method for creating normalized images \citep{ashburner:friston:spnorm:1999,mazz:toga:atlas:1995}.

Other common preprocessing steps include spatial smoothing and slice-timing correction. Spatial smoothing is intended to get rid of some of the noise in the data and allow for the use of Gaussian random field theory when applying a correction for multiple hypothesis tests. Slice-timing correction adjusts for the fact that brain slices taken during a particular TR don't occur at the same time. For the word recognition experiment, the data were spatial smoothed with an 8 mm full-width at half maximum isotropic Gaussian kernel. Slice-timing correction was not applied to the data and is not typically used when the TR is less than 2 seconds \citep{penny:spm:2011}.

The top panel of Figure \ref{fig:fmri:data} show the observed fMRI time series for a voxel in IPS-left. Notice that the pattern of the observed time series somewhat mirrors the active response displayed in the middle panel for TRs greater than 75, but not for TRs less than 75. This type of behavior motivates our thinking that a regression model with a changing slope, such as $M_{011}$, might be appropriate for modeling fMRI data.

\begin{figure}
\ssp
\centering
\caption{Single voxel time series from fMRI experiment} \label{fig:fmri:data}
\includegraphics[width=1.0\textwidth]{fmri-craig-data}
\caption*{Time series data (top), expected BOLD response (middle), and haemodynamic response function (bottom) versus TR for voxel 27 in the left intraparietal sulcus.}
\end{figure}

\section{Temporal autocorrelation \label{sec:fmri:cor}}

\subsection{Exploration of ARMA models \label{sec:fmri:arma}}

\begin{table}
\ssp
\centering
\caption{Mean AR and MA orders for experimental fMRI data} \label{fig:fmri:arma}
\begin{tabular}{|l|cc|cc|cc|}
\hline
Region & \multicolumn{6}{|c|}{Criterion} \\
\hline
 & \multicolumn{2}{|c|}{AIC} & \multicolumn{2}{|c|}{AICC} & \multicolumn{2}{|c|}{BIC} \\
\hline
 & $P$ & $Q$ & $P$ & $Q$ & $P$ & $Q$ \\
\hline
Left frontal pole          & 2.80 & 3.20 & 2.80 & 2.90 & 1.70 & 0.90 \\
Left intraparietal sulcus  & 3.75 & 3.50 & 3.50 & 3.25 & 1.81 & 0.06 \\
Right intraparietal sulcus & 3.20 & 2.80 & 3.20 & 2.80 & 0.80 & 0.80 \\
Primary visual             & 3.10 & 3.00 & 3.10 & 2.70 & 0.90 & 1.70 \\
Secondary visual left      & 3.20 & 2.90 & 2.10 & 2.40 & 1.40 & 0.00 \\
Secondary visual right     & 3.20 & 3.00 & 3.10 & 2.50 & 0.70 & 0.70 \\
\hline
Mean across regions     & 3.21 & 3.07 & 2.97 & 2.76 & 1.22 & 0.69 \\
\hline
\end{tabular}
\caption*{Mean AR and MA orders ($P$ and $Q$, respectively) chosen according to AIC, AICC, and BIC for fits of regression models with ARMA errors to voxel-wise time series from 5 by 5 by 5 voxel cubes taken from 6 different brain regions.}
\end{table}

\subsection{False positive rates \label{sec:fmri:fpr}}

\begin{figure}
\ssp
\centering
\caption{False positive rates for simulated fMRI data} \label{fig:fmri:fpr}
\includegraphics[width=1.0\textwidth]{simstudy-FPR}
\caption*{False positive rates (solid lines) and 95\% confidence intervals (dashed lines) for testing $H_0: \beta_1 = 0$ vs $H_A: \beta_1 > 0$ versus the nominal threshold level $\alpha$ (gray line) using OLS (black lines), PW (red lines), REML (green lines), and REMLc (blue lines) on simulated data from $M_{100}$ with $\beta = (750, 0)$, $\sigma^2_s = 15$, and increasing $\phi$ (plot panels).}
\end{figure}

\begin{table}
\ssp
\centering
\caption{False positive rates for simulated fMRI data} \label{tab:fmri:fpr}
\begin{tabular}{|c|cccc|}
\hline
$\alpha$ & OLS & PW & REML & REMLc \\
\hline
 & \multicolumn{4}{|c|}{$\phi = 0.25$} \\
\hline
0.001 & 0.006 & 0.001 & 0.001 & 0.001 \\
0.010 & 0.028 & 0.011 & 0.010 & 0.010 \\
0.050 & 0.106 & 0.050 & 0.049 & 0.048 \\
\hline
 & \multicolumn{4}{|c|}{$\phi = 0.50$} \\
\hline
0.001 & 0.022 & 0.002 & 0.002 & 0.002 \\
0.010 & 0.070 & 0.010 & 0.009 & 0.007 \\
0.050 & 0.161 & 0.054 & 0.052 & 0.052 \\
\hline
 & \multicolumn{4}{|c|}{$\phi = 0.75$} \\
\hline
0.001 & 0.061 & 0.001 & 0.001 & 0.000 \\
0.010 & 0.130 & 0.017 & 0.016 & 0.015 \\
0.050 & 0.213 & 0.064 & 0.062 & 0.055 \\
\hline
 & \multicolumn{4}{|c|}{$\phi = 0.95$} \\
\hline
0.001 & 0.072 & 0.000 & 0.000 & 0.000 \\
0.010 & 0.144 & 0.011 & 0.011 & 0.000 \\
0.050 & 0.230 & 0.046 & 0.049 & 0.023 \\
\hline
\end{tabular}
\caption*{False positive rates at significance levels $\alpha = 0.001, 0.01, \mbox{ and } 0.05$ (rows) for testing $H_0: \beta_1 = 0$ vs $H_A: \beta_1 > 0$ using OLS, PW, REML, and REMLc (columns) on simulated data from $M_{100}$ with $\beta = (750, 3)$, $\sigma^2_s = 15$, and increasing $\phi$ (embedded tables).}
\end{table}

\begin{figure}
\ssp
\centering
\caption{ROC curves for simulated fMRI data} \label{fig:fmri:roc}
\includegraphics[width=1.0\textwidth]{simstudy-ROC-3}
\caption*{ROC curves for testing $H_0: \beta_1 = 0$ vs $H_A: \beta_1 > 0$ using OLS (black lines), PW (red lines), REML (green lines), and REMLc (blue lines) on simulated data from $M_{100}$ with $\beta = (750, 3)$, $\sigma^2_s = 15$, and increasing $\phi$ (plot panels).}
\end{figure}

\subsection{Testing independence of residuals \label{sec:fmri:res}}

\begin{table}
\ssp
\centering
\caption{Proportion of whitened residuals for simulated fMRI data} \label{tab:fmri:res}
\begin{tabular}{|c|ccc|}
\hline
$\alpha$ & OLS & AR(1) & AR(2) \\
\hline
 & \multicolumn{3}{|c|}{$\phi = 0.25$} \\
\hline
0.001 & 0.332 & 1.000 & 1.000 \\
0.010 & 0.134 & 1.000 & 1.000 \\
0.050 & 0.028 & 1.000 & 1.000 \\
\hline
 & \multicolumn{3}{|c|}{$\phi = 0.50$} \\
\hline
0.001 & 0.000 & 1.000 & 1.000 \\
0.010 & 0.000 & 1.000 & 1.000 \\
0.050 & 0.000 & 0.999 & 1.000 \\
\hline
 & \multicolumn{3}{|c|}{$\phi = 0.75$} \\
\hline
0.001 & 0.000 & 1.000 & 1.000 \\
0.010 & 0.000 & 1.000 & 1.000 \\
0.050 & 0.000 & 0.994 & 1.000 \\
\hline
 & \multicolumn{3}{|c|}{$\phi = 0.95$} \\
\hline
0.001 & 0.000 & 1.000 & 1.000 \\
0.010 & 0.000 & 0.991 & 1.000 \\
0.050 & 0.000 & 0.958 & 1.000 \\
\hline
\end{tabular}
\caption*{Proportion of whitened residuals determined by Ljung-Box test at varying significance levels $\alpha$ (rows) from fitting data simulated from $M_{100}$ with $\beta = 3$, $\sigma^2_s = 15$, and increasing $\phi$ (embedded tables) to regression models with independent (OLS), AR(1), and AR(2) error structures.}
\end{table}

\clearpage

\section{Fitting dynamic regression models \label{sec:fmri:dr}}

\subsection{Model identifiability \label{sec:fmri:id}}

\begin{figure}
\ssp
\centering
\caption{Identifying dynamic slope model by increasing signal-to-noise ratio} \label{fig:fmri:id:M011SNR}
\includegraphics[width=0.75\textwidth]{1000-250-M011-conv-750-15-1-5-SNR-10-10}
\caption*{Histograms in 1D (for $\phi$, second column) and 2D (for $\beta$ and $(\sigma^2_s,\sigma^2_m)$, 1st and 3rd columns) of MLEs of fits of $M_{011}$ to data simulated from $M_{011}$ with $\beta = (750,15)'$, $\phi = 0.1$, $\sigma^2_m = 10$, and increasing $\sigma^2_s$ (rows).}
\end{figure}

\begin{figure}
\ssp
\centering
\caption{Identifying dynamic slope model by increasing autocorrelation} \label{fig:fmri:id:M011PRR}
\includegraphics[width=1.0\textwidth]{1000-250-M011-conv-750-15-PRR-5-1-10-10}
\caption*{Histograms in 1D (for $\phi$, second column) and 2D (for $\beta$ and $(\sigma^2_s,\sigma^2_m)$, 1st and 3rd columns) of MLEs of fits of $M_{011}$ to data simulated from $M_{011}$ with $\beta = (750,15)'$, $\sigma^2_s = 1$, $\sigma^2_m = 10$, and increasing $\phi$ (rows).}
\end{figure}

\begin{figure}
\ssp
\centering
\caption{Identifying dynamic intercept model by increasing signal-to-noise ratio} \label{fig:fmri:id:M101SNR}
\includegraphics[width=0.75\textwidth]{1000-250-M101-conv-750-15-1-5-SNR-10-10}
\caption*{Histograms in 1D (for $\phi$, second column) and 2D (for $\beta$ and $(\sigma^2_s,\sigma^2_m)$, 1st and 3rd columns) of MLEs of fits of $M_{101}$ to data simulated from $M_{101}$ with $\beta = (750,15)'$, $\phi = 0.1$, $\sigma^2_m = 10$, and increasing $\sigma^2_s$ (rows).}
\end{figure}

\begin{figure}
\ssp
\centering
\caption{Identifying dynamic intercept model by increasing autocorrelation} \label{fig:fmri:id:M101PRR}
\includegraphics[width=1.0\textwidth]{1000-250-M101-conv-750-15-PRR-5-1-10-10}
\caption*{Histograms in 1D (for $\phi$, second column) and 2D (for $\beta$ and $(\sigma^2_s,\sigma^2_m)$, 1st and 3rd columns) of MLEs of fits of $M_{101}$ to data simulated from $M_{101}$ with $\beta = (750,15)'$, $\sigma^2_s = 1$, $\sigma^2_m = 10$, and increasing $\phi$ (rows).}
\end{figure}

\begin{figure}
\ssp
\centering
\caption{Identifying model with both dynamic slope and intercept with small intercept variance} \label{fig:fmri:id:M111lowb}
\includegraphics[width=1.0\textwidth]{1000-250-M111-conv-750-15-9-6-SNR-1-10}
\caption*{Histograms in 1D (for $\sigma^2_m$, last column) and 2D (for $\beta$, $(\phi,\rho)$ and $(\sigma^2_s,\sigma^2_m)$, first 3 columns) of MLEs of fits of $M_{111}$ to data simulated from $M_{111}$ with $\beta = (750,15)'$, $\phi = 0.9$, $\rho = 0.6$, $\sigma^2_b = 1$, $\sigma^2_m = 10$, and increasing $\sigma^2_s$ (rows).}
\end{figure}

\begin{figure}
\ssp
\centering
\caption{Identifying model with both dynamic slope and intercept with large intercept variance} \label{fig:fmri:id:M111highb}
\includegraphics[width=1.0\textwidth]{1000-250-M111-conv-750-15-9-6-SNR-20-10}
\caption*{Histograms in 1D (for $\sigma^2_m$, last column) and 2D (for $\beta$, $(\phi,\rho)$ and $(\sigma^2_s,\sigma^2_m)$, first 3 columns) of MLEs of fits of $M_{111}$ to data simulated from $M_{111}$ with $\beta = (750,15)'$, $\phi = 0.9$, $\rho = 0.6$, $\sigma^2_b = 20$, $\sigma^2_m = 10$, and increasing $\sigma^2_s$ (rows).}
\end{figure}

\subsection{Fitting real fMRI data \label{sec:fmri:mle}}

\begin{figure}
\ssp
\centering
\caption{Histograms of MLEs for regression coefficients} \label{fig:fmri:mle:beta}
\includegraphics[width=0.6\textwidth]{craig_mle-beta}
\caption*{Two-dimensional histograms of MLEs of $\beta$ for real fMRI data from six brain regions (rows) fitted to dynamic regression models (columns). Blue X's denote the marginal averages of the MLEs from each brain region, and for each of two clusters in SV-left and SV-right.}
\end{figure}

\begin{figure}
\ssp
\centering
\caption{Histograms of MLEs for autocorrelation coefficient} \label{fig:fmri:mle:phi}
\includegraphics[width=0.4\textwidth]{craig_mle-phi}
\caption*{Histograms if MLEs of $\phi$ for real fMRI data from six brain regions (rows) fitted to dynamic regression models (columns). Blue vertical lines denote the average MLE of $\phi$ from each brain region, and for each of two clusters in SV-left and SV-right.}
\end{figure}

\begin{figure}
\ssp
\centering
\caption{Histograms of MLEs for state and observation variances} \label{fig:fmri:mle:sigma}
\includegraphics[width=0.6\textwidth]{craig_mle-sigma}
\caption*{Two-dimensional histograms of MLEs of $(\sigma^2_s,\sigma^2_m)$ for real fMRI data from six brain regions (rows) fitted to dynamic regression models (columns). Blue X's denote the marginal averages of the MLEs from each brain region, and for each of two clusters in SV-left and SV-right.}
\end{figure}

\begin{table}
\ssp
\centering
\caption{Average MLEs in single cluster brain regions} \label{tab:fmri:mle:means}
\begin{tabular}{|l|rrrr|}
\hline
Parameter & FP & IPS-left & IPS-right & PV \\
\hline
 & \multicolumn{4}{|c|}{$M_{011}$} \\
\hline
$\beta_0$ & 759.155 & 951.101 & 831.359 & 808.257 \\
$\beta_1$ & 1.395 & 15.009 & 24.894 & 16.492 \\
$\phi$ & 0.736 & 0.853 & 0.871 & 0.832 \\
$\sigma^2_s$ & 8.746 & 27.268 & 53.171 & 70.646 \\
$\sigma^2_m$ & 10.031 & 22.522 & 41.340 & 21.826 \\
\hline
 & \multicolumn{4}{|c|}{$M_{101}$} \\
\hline
$\beta_0$ & 759.875 & 950.038 & 830.901 & 807.434 \\
$\beta_1$ & -1.032 & 18.879 & 26.838 & 21.247 \\
$\phi$ & 0.746 & 0.637 & 0.654 & 0.596 \\
$\sigma^2_s$ & 3.323 & 16.970 & 29.565 & 23.498 \\
$\sigma^2_m$ & 6.105 & 0.534 & 1.382 & 1.727 \\
\hline
 & \multicolumn{4}{|c|}{$M_{001}$} \\
\hline
$\beta_0$ & 759.204 & 950.773 & 831.191 & 807.846 \\
$\beta_1$ & -1.448 & 16.087 & 24.688 & 19.039 \\
$\sigma^2_m$ & 12.480 & 29.579 & 54.511 & 37.629 \\
\hline
\end{tabular}
\caption*{Average MLEs calculated marginally for each fixed parameter (rows) for real fMRI data from four different brain regions (columns) fit to dynamic regression models (embedded tables).}
\end{table}

\begin{table}
\ssp
\centering
\caption{Average MLEs in bi-cluster brain regions} \label{tab:fmri:mle:clusters}
\begin{tabular}{|l|rr|rr|}
\hline
Parameter & \multicolumn{2}{|c|}{SV-left} & \multicolumn{2}{|c|}{SV-right} \\
\hline
 & Cluster H & Cluster L & Cluster H & Cluster L \\
\hline
 & \multicolumn{4}{|c|}{$M_{011}$} \\
\hline
$\beta_0$ & 874.999 & 363.601 & 697.816 & 308.080 \\
$\beta_1$ & 23.133 & 12.203 & 21.767 & 9.415 \\
$\phi$ & 0.566 & 0.520 & 0.489 & 0.630 \\
$\sigma^2_s$ & 11.475 & 4.378 & 13.162 & 4.889 \\
$\sigma^2_m$ & 0.502 & 0.393 & 2.423 & 3.906 \\
\hline
 & \multicolumn{4}{|c|}{$M_{101}$} \\
\hline
$\beta_0$ & 875.319 & 362.054 & 698.025 & 307.655 \\
$\beta_1$ & 20.009 & 11.708 & 13.883 & 9.361 \\
$\phi$ & 0.821 & 0.761 & 0.979 & 0.864 \\
$\sigma^2_s$ & 11.941 & 7.986 & 1.727 & 7.427 \\
$\sigma^2_m$ & 14.116 & 4.953 & 16.345 & 8.719 \\
\hline
 & \multicolumn{4}{|c|}{$M_{001}$} \\
\hline
$\beta_0$ & 875.084 & 361.957 & 697.769 & 307.538 \\
$\beta_1$ & 22.414 & 12.135 & 21.723 & 10.168 \\
$\sigma^2_m$ & 17.409 & 6.332 & 19.450 & 11.108 \\
\hline
\end{tabular}
\caption*{Average MLEs calculated marginally for each fixed parameter (rows) for real fMRI data from each cluster of secondary visual left and secondary visual right (columns) fit to dynamic regression models (embedded tables).}
\end{table}

\begin{table}
\ssp
\centering
\caption{Proportion of voxels with high activation} \label{tab:fmri:prop}
\begin{tabular}{|c|cc|}
\hline
Model & SV-left & SV-right \\
\hline
$M_{011}$ & 0.672 & 0.648 \\
$M_{101}$ & 0.677 & 0.648 \\
$M_{001}$ & 0.672 & 0.648 \\
\hline
\end{tabular}
\caption*{Proportion of voxels in each of secondary visual left and right (columns) classified into high activation cluster for each model fit (rows).}
\end{table}

\section{Comparing dynamic regression models using PL \label{sec:fmri:pl}}

\subsection{PL on simulated fMRI data \label{sec:fmri:sim}}

\begin{figure}
\ssp
\centering
\caption{Simulated rapid-event related design of fMRI experiment} \label{fig:fmri:design}
\includegraphics[width=1.0\textwidth]{fmri-design-3-500-1}
\caption*{Simulated boxcar function (top), hrf (middle), and convolution of the boxcar with the hrf (bottom) for a rapid-event related design of an fMRI experiment.}
\end{figure}

\begin{figure}
\ssp
\centering
\caption{Simulated fMRI data from dynamic slope model} \label{fig:fmri:sim}
\includegraphics[width=1.0\textwidth]{fmri-ar-sim-750-15-99-2-5-M101}
\caption*{Simulated fMRI time series $y_t$ (top) from $M_{011}$ with $\beta = (750,15)'$, $\phi = 0.99$, $\sigma^2_s = 2$, and $\sigma^2_m = 5$. Convolution of the hrf and neural activation pattern $\mbox{conv}_t$ and simulated change in dynamic slope $x_t$ are displayed in the middle and bottom panels, respectively.}
\end{figure}

\begin{figure}
\ssp
\centering
\caption{Credible intervals from PL compared with MCMC for simulated fMRI data} \label{fig:fmri:quant}
\includegraphics[width=1.0\textwidth]{fmri_pl_quant-M101-M101-560-1-1-FALSE-FALSE-FALSE}
\caption*{Sequential 95\% credible intervals for the filtered distributions of the dynamic slope (top left) and fixed parameters (other panels) of $M_{011}$ using PL with increasing number of particles (colors) compared with MCMC (black X's) run on simulated data from $M_{011}$ with $\beta = (750,15)'$, $\phi = 0.95$, $\sigma^2_s = 10$, and $\sigma^2_m = 10$ (displayed above top middle panel). True values of fixed parameters used for simulation and true simulated dynamic slopes are indicated by gray lines. MCMC estimates are displayed only for the filtered distributions of $\beta_1 + x_T$ and the fixed parameters conditional on all the data ($T = 250$). The same prior distributions on the initial state and fixed parameters were used for running both PL and MCMC, with $p(x_0) = \delta_{0}(x_0)$, $b_0$ and $\phi_0$ set to the true $\beta$ and $\phi$, respectively, and remaining hyperparameters displayed above the top left and right panels.}
\end{figure}

\subsection{Distinguishing dynamic regression models \label{sec:fmri:dist}}

\begin{figure}
\ssp
\centering
\caption{Distinguishing the dynamic slope model from the dynamic intercept and simple linear regression models} \label{fig:fmri:phi:M011}
\includegraphics[width=1.0\textwidth]{fmri_pl_loglik-M101-1-500-phi-496-594-1}
\caption*{Log marginal likelihoods of data coming from different dynamic regression models (colored lines) when simulated from $M_{011}$ with $\sigma^2_m = 10$ and increasing $\phi$ (x-axis) and $\sigma^2_s$. Log marginal likelihoods from three independent PL runs with each model, for each simulation, are displayed by colored points.}
\end{figure}

\begin{figure}
\ssp
\centering
\caption{Distinguishing the dynamic intercept model from the dynamic slope and simple linear regression models} \label{fig:fmri:phi:M101}
\includegraphics[width=1.0\textwidth]{fmri_pl_loglik-M011-1-500-phi-496-594-1}
\caption*{Log marginal likelihoods of data coming from different dynamic regression models (colored lines) when simulated from $M_{101}$ with $\sigma^2_m = 10$ and increasing $\phi$ (x-axis) and $\sigma^2_s$. Log marginal likelihoods from three independent PL runs with each model, for each simulation, are displayed by colored points.}
\end{figure}

\begin{figure}
\ssp
\centering
\caption{Distinguishing the dynamic slope model from the dynamic intercept and simple linear regression models with increasing prior variance} \label{fig:fmri:kappa:M011}
\includegraphics[width=1.0\textwidth]{fmri_pl_loglik-phiSNR-M101-3-500-496-594-1-5-10-15}
\caption*{Points $(\phi,\sigma^2_s / \sigma^2_m)$ at which $M_{011}$ is distinguished from $M_{101}$ and $M_{001}$ as being most likely to generate data simulated from $M_{011}$ with $\beta = (750,15)'$ and increasing prior variance $\kappa$ (plot panels). $M_{011}$ is determined to be distinguished from the other models if log marginal likelihood estimates from each of three PL runs for $M_{011}$ are greater than estimates from all three PL runs with each of the other models. Points are displayed for each of three separate simulations at each set of fixed parameter values. If log likelihood estimates for $M_{011}$ never exceed those for the other models for all three runs, no point is plotted.}
\end{figure}

\begin{figure}
\ssp
\centering
\caption{Distinguishing the dynamic intercept model from the dynamic slope and simple linear regression models with increasing prior variance} \label{fig:fmri:kappa:M101}
\includegraphics[width=1.0\textwidth]{fmri_pl_loglik-phiSNR-M011-3-500-496-594-1-5-10-15}
\caption*{Points $(\phi,\sigma^2_s / \sigma^2_m)$ at which $M_{101}$ is distinguished from $M_{011}$ and $M_{001}$ as being most likely to generate data simulated from $M_{101}$ with $\beta = (750,15)'$ and increasing prior variance $\kappa$ (plot panels). $M_{101}$ is determined to be distinguished from the other models if log marginal likelihood estimates from each of three PL runs for $M_{101}$ are greater than estimates from all three PL runs with each of the other models. Points are displayed for each of three separate simulations at each set of fixed parameter values. If log likelihood estimates for $M_{011}$ never exceed those for the other models for all three runs, no point is plotted.}
\end{figure}

\begin{figure}
\ssp
\centering
\caption{Log marginal likelihoods of data simulated from dynamic slope model with increasing particles in PL} \label{fig:fmri:loglik:M011}
\includegraphics[width=1.0\textwidth]{fmri_pl_loglik-M101-498-1}
\caption*{Kernel density approximation to the distribution of 20 log marginal likelihood estimates for $M_{011}$ (black lines) and $M_{101}$ (red lines) along with true log marginal likelihood of $M_{001}$ (blue vertical lines) using PL with increasing number of particles (plot panels) on simulated data from $M_{011}$ with $\beta = (750,15)'$, $\phi = 0.3$, $\sigma^2_s = 1$, and $\sigma^2_m = 10$.}
\end{figure}

\begin{figure}
\ssp
\centering
\caption{Log marginal likelihoods of data simulated from dynamic intercept model with increasing particles in PL} \label{fig:fmri:loglik:M101}
\includegraphics[width=1.0\textwidth]{fmri_pl_loglik-M011-500-1}
\caption*{Kernel density approximation to the distribution of 20 log marginal likelihood estimates for $M_{011}$ (black lines) and $M_{101}$ (red lines) along with true log marginal likelihood of $M_{001}$ (blue vertical lines) using PL with increasing number of particles (plot panels) on simulated data from $M_{101}$ with $\beta = (750,15)'$, $\phi = 0.5$, $\sigma^2_s = 1$, and $\sigma^2_m = 10$.}
\end{figure}

\begin{figure}
\ssp
\centering
\caption{Ternary diagrams of posterior model probabilities for simulated fMRI data from dynamic slope model} \label{fig:fmri:comp:M011}
\includegraphics[width=1.0\textwidth]{fmri_pl_comp-M101-498-1}
\caption*{Posterior model probabilities among dynamic regression models (corners of triangles) for twenty runs of the PL (black dots) for increasing number of particles (plot panels) on data simulated from $M_{011}$ with $\beta = (750,15)'$, $\phi = 0.3$, $\sigma^2_s = 1$, and $\sigma^2_m = 10$. Each point represents a set of posterior probabilities (one for each model), and the proximity of the point to a particular corner of the triangle represents the posterior probability of the model in that corner relative to the other models.}
\end{figure}

\begin{figure}
\ssp
\centering
\caption{Ternary diagrams of posterior model probabilities for simulated fMRI data from dynamic intercept model} \label{fig:fmri:comp:M101}
\includegraphics[width=1.0\textwidth]{fmri_pl_comp-M011-500-1}
\caption*{Posterior model probabilities among dynamic regression models (corners of triangles) for twenty runs of the PL (black dots) for increasing number of particles (plot panels) on data simulated from $M_{101}$ with $\beta = (750,15)'$, $\phi = 0.5$, $\sigma^2_s = 1$, and $\sigma^2_m = 10$. Each point represents a set of posterior probabilities (one for each model), and the proximity of the point to a particular corner of the triangle represents the posterior probability of the model in that corner relative to the other models.}
\end{figure}

\subsection{Real fMRI data \label{sec:fmri:real}}

\begin{figure}
\ssp
\centering
\caption{Log marginal likelihoods of real fMRI data} \label{fig:fmri:loglik:real}
\includegraphics[width=1.0\textwidth]{craig_pl-loglik-1-5000-1-FALSE-FALSE-FALSE}
\caption*{Kernel density approximation to the distribution of log marginal likelihood estimates of data from 125 voxels from each of 6 different brain regions (plot panels) for $M_{011}$ (black lines) and $M_{101}$ (red lines) along with true log marginal likelihood of $M_{001}$ (blue vertical lines) using PL with 5000 particles.}
\end{figure}

\begin{table}
\ssp
\centering
\caption{Proportion of voxels favoring different regression models} \label{}
\begin{tabular}{|c|ccc|}
\hline
Region & $M_{101}$ & $M_{011}$ & $M_{001}$ \\
\hline
FP & 0.976 & 0.000 & 0.024 \\
IPS-left & 0.992 & 0.008 & 0.000 \\
IPS-right & 0.880 & 0.096 & 0.024 \\
PV & 1.000 & 0.000 & 0.000 \\
SV-left & 0.800 & 0.144 & 0.056 \\
SV-right & 0.952 & 0.032 & 0.016 \\
\hline
\end{tabular}
\caption*{Proportion of voxels in each brain region (rows) with highest posterior model probability coming from each of $M_{101}$, $M_{011}$, and $M_{001}$ (columns). For $M_{101}$ and $M_{011}$, posterior model probabilities were calculated using the PL with 5000 particles. For $M_{001}$, the true posterior model probability was calculated analytically.}
\end{table}

\begin{figure}
\ssp
\centering
\caption{Posterior probabilities of dynamic regression models for real fMRI data} \label{fig:fmri:comp:real}
\includegraphics[width=1.0\textwidth]{craig_pl-comp-1-5000-1-FALSE-FALSE-FALSE}
\caption*{Posterior model probabilities among dynamic regression models (corners of triangles) for 125 voxels (black dots) in each of 6 brain regions (plot panels) using the PL with 5000 particles. Each point represents a set of posterior probabilities (one for each model), and the proximity of the point to a particular corner of the triangle represents the posterior probability of the model in that corner relative to the other models.}
\end{figure}

\begin{figure}
\ssp
\centering
\caption{Filtered dynamic slopes and posterior model probabilities for data from SV-left} \label{fig:fmri:slopes:real}
\includegraphics[width=1.0\textwidth]{craig_state-pl-SV-left-M101-3-FALSE-5000}
\caption*{Sequential 95\% credible intervals for dynamic slopes (lines) and 95\% credible intervals for $\phi|y_{1:T}$ (displayed above plot panels) along with cluster classification (color of lines) and posterior model probabilities (colored bar along top of plots) using the PL with 5000 particles on a 5 by 5 slice of voxels in the y-z plane of secondary visual left. The proportion of the solid bar colored for a particular model represents the posterior probability of that model relative to the others.}
\end{figure}

%Priors:
%
%\begin{align*}
%\beta \sim \mbox{N}(b_0,B_0) &\quad \sigma^2_m \sim \mbox{IG}(a_{m_0},b_{m_0}) \\
%\phi \sim \mbox{N}(\phi_0,\Phi_0) &\quad \sigma^2_s \sim \mbox{IG}(a_{s_0},b_{s_0})
%\end{align*}
%
%Let \[B_0 = \kappa^2 \left(\begin{array}{cc} 1000 & 0 \\ 0 & 225 \end{array}\right) \quad \Phi_0 = \kappa^2\times0.25.\] $b_0$ and $\phi_0$ are set to true values used for simulating data, or MLEs if true values are unknown, i.e. for real data. $a_{m_0}$, $b_{m_0}$, $a_{s_0}$, and $b_{s_0}$ are set such that mean of each inverse-gamma prior is equal to the true values or MLEs for estimating $\sigma^2_m$ and $\sigma^2_s$, and such that the variance of the inverse-gamma priors are equal to $\kappa^2\times500$.
